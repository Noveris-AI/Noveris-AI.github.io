# 安全设计检查清单

## ✅ 已实现的安全措施

### 1. API 密钥保护
- [x] AI API Key 仅存储在服务端环境变量
- [x] 通过 Next.js Route Handlers 调用 AI，浏览器直连被阻止
- [x] .env.local 在 .gitignore 中
- [x] .env.example 提供模板但不包含真实密钥

### 2. 输入验证
- [x] 使用 Zod schema 严格校验所有用户输入
- [x] 字符串长度限制（whatIdid, partnerFeelings, myAttitude 最大 5000 字符）
- [x] 枚举值验证（conflictType, relationshipStage, channel, tone）
- [x] 最小长度检查（关键描述至少 20 字符）

### 3. 输出校验
- [x] AI 输出必须通过 RepairPlanSchema 校验
- [x] 校验失败自动重试 1 次
- [x] 所有必填字段必须存在
- [x] 字段长度和格式符合规范

### 4. 安全策略层
- [x] Prompt 中明确禁止操控性/威胁性内容
- [x] 关键词检测（情感勒索、威胁、跟踪等）
- [x] 危险情况触发安全警告（自伤、暴力）
- [x] 防越狱机制（检测试图绕过规则的输入）

### 5. 速率限制
- [x] 按用户 ID 和 IP 的速率限制
- [x] 内存存储（开发环境）
- [x] Redis 存储（生产环境，通过 Upstash）
- [x] 不同操作不同限制（create_case: 5/小时, regenerate: 10/小时）

### 6. 认证与授权
- [x] Supabase Auth 集成
- [x] Middleware 路由保护
- [x] 服务端 getUser() 验证
- [x] API 路由权限检查
- [x] Case 数据所有权验证（用户只能访问自己的案例）

### 7. CSRF 与会话安全
- [x] Next.js sameSite cookies
- [x] Supabase SSR 客户端（安全 cookie 处理）
- [x] Middleware 刷新会话

### 8. 隐私保护
- [x] 默认不保存原始输入（saveRawInputs: false）
- [x] 用户可一键删除案例
- [x] 用户可删除账号（级联删除所有数据）
- [x] 日志脱敏（仅记录 hash 和长度）

### 9. HTTP 安全头
- [x] X-Frame-Options: SAMEORIGIN
- [x] X-Content-Type-Options: nosniff
- [x] Referrer-Policy: origin-when-cross-origin
- [x] X-DNS-Prefetch-Control

### 10. 数据库安全
- [x] Prisma ORM（防 SQL 注入）
- [x] 用户数据隔离（WHERE userId 过滤）
- [x] 外键级联删除
- [x] 事务一致性

## 🔍 需要额外关注的领域

### 1. 生产环境强化
建议添加：
- [ ] WAF (Web Application Firewall)
- [ ] DDoS 保护
- [ ] API 请求签名验证
- [ ] 更严格的速率限制（基于信誉评分）

### 2. 监控与审计
建议添加：
- [ ] 结构化日志（JSON 格式）
- [ ] 异常追踪（Sentry）
- [ ] 安全事件告警
- [ ] 定期安全审计

### 3. 数据加密
建议添加：
- [ ] 数据库加密（静态加密）
- [ ] 敏感字段加密（如用户自带的 API Key）
- [ ] 备份加密

### 4. 合规性
根据部署地区考虑：
- [ ] GDPR（欧盟）
- [ ] CCPA（加州）
- [ ] PIPL（中国个人信息保护法）

## 🚨 已禁止的内容类型

通过 Prompt 和代码层面双重禁止：

1. **情感勒索**："让她内疚"、"让她难过"
2. **欺骗隐瞒**："假装改变"、"骗她一下"
3. **跟踪骚扰**："去她楼下等"、"一直发消息"
4. **威胁恐吓**："不听就..."、"威胁"
5. **冷暴力报复**："不理她"、"惩罚她"
6. **操控技巧**："让她求我"、"让她后悔"

## 🛡️ Prompt 安全原则

### 系统提示词包含：
- 明确禁止操控、威胁、情感勒索
- 强调尊重边界和知情同意
- 要求具体可验证的行动（不空话）
- 危险情况建议专业求助

### 开发者提示词要求：
- 严格 JSON 输出格式
- 所有字段必须填写
- 中文输出，语气克制真诚

### 用户输入处理：
- 拼接表单字段时保持语义
- 添加"对方雷点"约束
- 危险检测触发安全响应

## 📋 安全审查流程

部署前检查：
1. [ ] 所有环境变量已配置
2. [ ] .env.local 不在版本控制中
3. [ ] Supabase RLS 策略已启用
4. [ ] 速率限制正常工作
5. [ ] HTTPS 强制启用
6. [ ] 错误页面不泄露敏感信息
7. [ ] 日志不记录敏感内容

## 🔐 密钥管理最佳实践

1. **永远不要**：
   - 在代码中硬编码密钥
   - 将密钥提交到 Git
   - 在客户端代码中使用密钥

2. **应该**：
   - 使用环境变量
   - 定期轮换密钥
   - 为不同环境使用不同密钥
   - 使用密钥管理服务（如 AWS Secrets Manager）

## 📞 安全事件响应

如果发现安全漏洞：
1. 立即禁用受影响的功能
2. 通知用户（如涉及数据泄露）
3. 修复漏洞
4. 部署补丁
5. 进行事后分析

联系邮箱：[security@example.com]
